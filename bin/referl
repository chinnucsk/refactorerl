#!/bin/sh

# Unix shell script that starts RefactorErl. The same command line can be used
# on all platforms to start the server.

# Set defaults
ERL=erl
BASE=`pwd`
SERVER=yes
CLIENT=no
NAME=refactorerl@localhost

# Interpret arguments
while [ $# -gt 0 ]
do
    if [ "$1" = -erl ]
    then
        ERL="$2"
        shift 2
    elif [ "$1" = -base ]
    then
        BASE="$2"
        shift 2
    elif [ "$1" = -name ]
    then
        NAME="$2"
        shift 2
    elif [ "$1" = -server ]
    then
        SERVER=yes
        CLIENT=server
        shift
    elif [ "$1" = -emacs ]
    then
        CLIENT=emacs
        shift
    elif [ "$1" = -client ]
    then
        SERVER=no
        shift
    elif [ "$1" = -wrangler ]
    then
        WRANGLER="$2"
        shift 2
    elif [ "$1" = -help ]
    then
        cat <<HELP >&2
Usage: $0 [Option]...
Starts RefactorErl, using the current working directory as the data directory.

Recognised options:
  -erl PATH        Path to the Erlang executable to use
  -base PATH       Path to the RefactorErl base directory
  -wrangler PATH   Path to a Wrangler installation
  -name NAME       Erlang node name
  -server          Start in server mode (no shell is started)
  -client          Start in client mode (no server is started)
  -emacs           Start as an Emacs client
  -help            Print this help text
HELP
        exit
    fi
done

# Set extra arguments
[ $CLIENT = server ] && ARGS="-noinput"
[ $CLIENT = emacs ]  && ARGS="-noshell -run referl_emacs"


# The following feature appeared in R12B-2:
# export ERL_LIBS="$BASE/lib"

# Other possibility, which only works in Unix:
# -pa "$BASE/lib"/*/ebin

if [ $SERVER = yes ]
then
    "$ERL" \
        -sname  "$NAME" \
        -pa     "$BASE/lib"/refactorerl/ebin \
        -pa     "$BASE/lib"/clustering/ebin \
        -pa     "$BASE/lib"/test/ebin \
        -pa     "$BASE/build" \
        -boot   "$BASE/refactorerl" \
        -config "$BASE/sys.config" \
        ${WRANGLER:+-pa} ${WRANGLER:+"$WRANGLER"} \
        +W "w" \
        $ARGS
else
    "$ERL" \
        -sname  "$NAME" \
        -pa     "$BASE/lib"/refactorerl/ebin \
        $ARGS
fi
